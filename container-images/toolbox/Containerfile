ARG FEDORA_VERSION=40

FROM registry.fedoraproject.org/fedora-toolbox:${FEDORA_VERSION} AS builder

WORKDIR /build-final

ENV CARGO_HOME=/build/.cargo
RUN dnf install -y cargo
RUN --mount=type=cache,target=/build/.cargo,rw cargo install xh --locked
RUN cp ${CARGO_HOME}/bin/xh /build-final

FROM registry.fedoraproject.org/fedora-toolbox:${FEDORA_VERSION}

ARG NAME=my-fedora-toolbox
LABEL com.github.containers.toolbox="true" \
        name="$NAME" \
        version="1" \
        usage="This image is meant to be used with the toolbox(1) command" \
        summary="Image for creating Fedora Toolbx containers"

WORKDIR /build-final

COPY ./packages.txt .
RUN dnf --assumeyes update && \
        dnf --assumeyes install $(cat packages.txt) && \
        dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo && \
        dnf install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin -y && \
        dnf clean all


RUN wget https://raw.githubusercontent.com/ducaale/xh/master/completions/xh.fish -O /usr/share/fish/completions/xh.fish
RUN rm -r /build-final

VOLUME [ "/home/erb/.vscode-server" ]

RUN mkdir -p /home/erb/.vscode-server && groupadd -g 1000 erb && \
    useradd -m -u 1000 -g erb erb && \
    chown -R erb:erb /home/erb && chmod g+r+w+s /home/erb && \
    chsh --shell /usr/bin/fish erb

USER erb:erb
